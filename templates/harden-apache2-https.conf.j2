{{ ansible_managed | comment }}
## HTTPS server settings

SSLCipherSuite {{ harden_apache_sslciphersuite }}
SSLProtocol {{ harden_apache_sslprotocol }}
SSLHonorCipherOrder On

{% if ansible_distribution_release == 'xenial' %}
SSLOpenSSLConfCmd DHParameters "{{ ssl_privatedir }}/dhparam.pem"

{% endif %}
# Requires Apache >= 2.4
SSLCompression off 
## needs to be created, not possible to test with self-signed certificate
#SSLCACertificateFile /etc/ssl/ca-certs.pem
{% if hardenwebserver_cert is defined and hardenwebserver_cert == 'letsencrypt' %}
SSLCACertificateFile {{ ssl_dir }}/ca-certs.pem
{% endif %}

{% if hardenwebserver_apache_sessiontickets is not defined or not hardenwebserver_apache_sessiontickets %}
# Requires Apache >= 2.4.11, TLS session tickets are enabled by default. Using them without restarting the web server with an appropriate frequency (e.g. daily) compromises perfect forward secrecy.
# https://httpd.apache.org/docs/trunk/mod/mod_ssl.html#sslsessiontickets
#SSLSessionTickets Off
{% else %}
#SSLSessionTickets On
##  it is recommended to not configure a ticket key file, but to rely on (random) keys generated by mod_ssl at startup, instead.
#SSLSessionTicketKeyFile file-path
{% endif %}

{% if hardenwebserver_cert_pinning is defined and hardenwebserver_cert_pinning and hardenwebserver_cert_pinning_value is defined and hardenwebserver_cert_pinning_value.stdout != '' %}
## HTTP Public Key Pinning
## https://raymii.org/s/articles/HTTP_Public_Key_Pinning_Extension_HPKP.html
## https://scotthelme.co.uk/hpkp-http-public-key-pinning/
## https://news.netcraft.com/archives/2016/03/30/http-public-key-pinning-youre-doing-it-wrong.html
## https://community.letsencrypt.org/t/hpkp-best-practices-if-you-choose-to-implement/4625          = not recommended/on your own
## https://blog.qualys.com/ssllabs/2016/09/06/is-http-public-key-pinning-dead
Header always set Public-Key-Pins pin-sha256="{{ hardenwebserver_cert_pinning_value.stdout }}"; max-age value 5184000; includeSubDomains
{% endif %}

## if mod_http2 available
#Protocols h2 http/1.1
